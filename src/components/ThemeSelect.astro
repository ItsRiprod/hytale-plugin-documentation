---
/**
 * Custom ThemeSelect component that presents combined theme options
 * (e.g., "Blue Dark", "Emerald Light") but internally sets two attributes:
 * - data-color-scheme: "dark" or "light"
 * - data-accent: "blue", "emerald", "amber", or "purple"
 *
 * This separation minimizes theme flash during navigation.
 */
---

<starlight-theme-select>
	<label>
		<span class="sr-only">Select theme</span>
		<select>
			<optgroup label="Blue (Default)">
				<option value="dark-blue">Blue Dark</option>
				<option value="light-blue">Blue Light</option>
			</optgroup>
			<optgroup label="Emerald">
				<option value="dark-emerald">Emerald Dark</option>
				<option value="light-emerald">Emerald Light</option>
			</optgroup>
			<optgroup label="Amber">
				<option value="dark-amber">Amber Dark</option>
				<option value="light-amber">Amber Light</option>
			</optgroup>
			<optgroup label="Purple">
				<option value="dark-purple">Purple Dark</option>
				<option value="light-purple">Purple Light</option>
			</optgroup>
		</select>
		<svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
			<path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
		</svg>
	</label>
</starlight-theme-select>

<script>
	type ColorScheme = 'dark' | 'light';
	type Accent = 'blue' | 'emerald' | 'amber' | 'purple';
	type ThemeValue = `${ColorScheme}-${Accent}`;

	class StarlightThemeSelect extends HTMLElement {
		#select: HTMLSelectElement | null = null;
		#SCHEME_KEY = 'starlight-color-scheme';
		#ACCENT_KEY = 'starlight-accent';

		constructor() {
			super();
			this.#select = this.querySelector('select');

			this.#init();

			this.#select?.addEventListener('change', () => {
				const value = this.#select?.value as ThemeValue;
				this.#setTheme(value);
			});

			// Handle View Transitions
			document.addEventListener('astro:before-swap', (e: any) => {
				const { scheme, accent } = this.#getStoredTheme();
				this.#applyToDocument(e.newDocument, scheme, accent);
			});

			document.addEventListener('astro:after-swap', () => {
				this.#syncSelect();
			});
		}

		#init() {
			const { scheme, accent } = this.#getStoredTheme();
			this.#applyToDocument(document, scheme, accent);
			this.#syncSelect();
		}

		#syncSelect() {
			const { scheme, accent } = this.#getStoredTheme();
			if (this.#select) {
				this.#select.value = `${scheme}-${accent}`;
			}
		}

		#getStoredTheme(): { scheme: ColorScheme; accent: Accent } {
			let scheme: ColorScheme = 'dark';
			let accent: Accent = 'blue';

			if (typeof localStorage !== 'undefined') {
				const storedScheme = localStorage.getItem(this.#SCHEME_KEY);
				if (storedScheme === 'dark' || storedScheme === 'light') {
					scheme = storedScheme;
				} else if (typeof window !== 'undefined' && window.matchMedia('(prefers-color-scheme: light)').matches) {
					scheme = 'light';
				}

				const storedAccent = localStorage.getItem(this.#ACCENT_KEY);
				if (storedAccent && ['blue', 'emerald', 'amber', 'purple'].includes(storedAccent)) {
					accent = storedAccent as Accent;
				}
			} else if (typeof window !== 'undefined' && window.matchMedia('(prefers-color-scheme: light)').matches) {
				scheme = 'light';
			}

			return { scheme, accent };
		}

		#setTheme(value: ThemeValue) {
			const [scheme, accent] = value.split('-') as [ColorScheme, Accent];

			if (typeof localStorage !== 'undefined') {
				localStorage.setItem(this.#SCHEME_KEY, scheme);
				localStorage.setItem(this.#ACCENT_KEY, accent);
			}

			this.#applyToDocument(document, scheme, accent);
		}

		#applyToDocument(doc: Document, scheme: ColorScheme, accent: Accent) {
			doc.documentElement.setAttribute('data-color-scheme', scheme);
			if (accent === 'blue') {
				doc.documentElement.removeAttribute('data-accent');
			} else {
				doc.documentElement.setAttribute('data-accent', accent);
			}
		}
	}

	customElements.define('starlight-theme-select', StarlightThemeSelect);
</script>

<style>
	starlight-theme-select {
		display: flex;
		align-items: center;
	}

	label {
		position: relative;
		display: flex;
		align-items: center;
		color: var(--sl-color-gray-2);
	}

	select {
		appearance: none;
		background: transparent;
		border: 1px solid var(--sl-color-hairline);
		border-radius: 0.5rem;
		color: var(--sl-color-gray-2);
		cursor: pointer;
		font-family: inherit;
		font-size: var(--sl-text-sm);
		padding: 0.5rem 2rem 0.5rem 0.75rem;
		transition: all 0.15s ease;
	}

	select:hover {
		border-color: var(--sl-color-accent);
		color: var(--sl-color-white);
	}

	select:focus {
		outline: 2px solid var(--sl-color-accent);
		outline-offset: 2px;
	}

	option {
		background: var(--sl-color-bg-nav);
		color: var(--sl-color-white);
	}

	optgroup {
		background: var(--sl-color-bg);
		color: var(--sl-color-gray-3);
		font-weight: 600;
	}

	svg {
		position: absolute;
		right: 0.5rem;
		pointer-events: none;
		color: var(--sl-color-gray-4);
	}

	.sr-only {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border-width: 0;
	}
</style>
